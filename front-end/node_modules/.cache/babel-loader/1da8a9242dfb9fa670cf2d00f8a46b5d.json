{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.validateTopicScoreParams = exports.validatePeerScoreParams = exports.createTopicScoreParams = exports.createPeerScoreParams = exports.defaultTopicScoreParams = exports.defaultPeerScoreParams = void 0;\n\nconst constants_1 = require(\"./constants\"); // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\n\n\nconst errcode = require(\"err-code\");\n\nexports.defaultPeerScoreParams = {\n  topics: {},\n  topicScoreCap: 10,\n  appSpecificScore: () => 0,\n  appSpecificWeight: 10,\n  IPColocationFactorWeight: -5,\n  IPColocationFactorThreshold: 10,\n  IPColocationFactorWhitelist: new Set(),\n  behaviourPenaltyWeight: -10,\n  behaviourPenaltyDecay: 0.2,\n  decayInterval: 1000,\n  decayToZero: 0.1,\n  retainScore: 3600 * 1000\n};\nexports.defaultTopicScoreParams = {\n  topicWeight: 0.5,\n  timeInMeshWeight: 1,\n  timeInMeshQuantum: 1,\n  timeInMeshCap: 3600,\n  firstMessageDeliveriesWeight: 1,\n  firstMessageDeliveriesDecay: 0.5,\n  firstMessageDeliveriesCap: 2000,\n  meshMessageDeliveriesWeight: -1,\n  meshMessageDeliveriesDecay: 0.5,\n  meshMessageDeliveriesCap: 100,\n  meshMessageDeliveriesThreshold: 20,\n  meshMessageDeliveriesWindow: 10,\n  meshMessageDeliveriesActivation: 5000,\n  meshFailurePenaltyWeight: -1,\n  meshFailurePenaltyDecay: 0.5,\n  invalidMessageDeliveriesWeight: -1,\n  invalidMessageDeliveriesDecay: 0.3\n};\n\nfunction createPeerScoreParams(p = {}) {\n  return Object.assign(Object.assign(Object.assign({}, exports.defaultPeerScoreParams), p), {\n    topics: p.topics ? Object.entries(p.topics).reduce((topics, [topic, topicScoreParams]) => {\n      topics[topic] = createTopicScoreParams(topicScoreParams);\n      return topics;\n    }, {}) : {}\n  });\n}\n\nexports.createPeerScoreParams = createPeerScoreParams;\n\nfunction createTopicScoreParams(p = {}) {\n  return Object.assign(Object.assign({}, exports.defaultTopicScoreParams), p);\n}\n\nexports.createTopicScoreParams = createTopicScoreParams; // peer score parameter validation\n\nfunction validatePeerScoreParams(p) {\n  for (const [topic, params] of Object.entries(p.topics)) {\n    try {\n      validateTopicScoreParams(params);\n    } catch (e) {\n      throw errcode(new Error(`invalid score parameters for topic ${topic}: ${e.message}`), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n  } // check that the topic score is 0 or something positive\n\n\n  if (p.topicScoreCap < 0) {\n    throw errcode(new Error('invalid topic score cap; must be positive (or 0 for no cap)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check that we have an app specific score; the weight can be anything (but expected positive)\n\n\n  if (p.appSpecificScore === null || p.appSpecificScore === undefined) {\n    throw errcode(new Error('missing application specific score function'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check the IP colocation factor\n\n\n  if (p.IPColocationFactorWeight > 0) {\n    throw errcode(new Error('invalid IPColocationFactorWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.IPColocationFactorWeight !== 0 && p.IPColocationFactorThreshold < 1) {\n    throw errcode(new Error('invalid IPColocationFactorThreshold; must be at least 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check the behaviour penalty\n\n\n  if (p.behaviourPenaltyWeight > 0) {\n    throw errcode(new Error('invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.behaviourPenaltyWeight !== 0 && (p.behaviourPenaltyDecay <= 0 || p.behaviourPenaltyDecay >= 1)) {\n    throw errcode(new Error('invalid BehaviourPenaltyDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check the decay parameters\n\n\n  if (p.decayInterval < 1000) {\n    throw errcode(new Error('invalid DecayInterval; must be at least 1s'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.decayToZero <= 0 || p.decayToZero >= 1) {\n    throw errcode(new Error('invalid DecayToZero; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // no need to check the score retention; a value of 0 means that we don't retain scores\n\n}\n\nexports.validatePeerScoreParams = validatePeerScoreParams;\n\nfunction validateTopicScoreParams(p) {\n  // make sure we have a sane topic weight\n  if (p.topicWeight < 0) {\n    throw errcode(new Error('invalid topic weight; must be >= 0'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check P1\n\n\n  if (p.timeInMeshQuantum === 0) {\n    throw errcode(new Error('invalid TimeInMeshQuantum; must be non zero'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.timeInMeshWeight < 0) {\n    throw errcode(new Error('invalid TimeInMeshWeight; must be positive (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.timeInMeshWeight !== 0 && p.timeInMeshQuantum <= 0) {\n    throw errcode(new Error('invalid TimeInMeshQuantum; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.timeInMeshWeight !== 0 && p.timeInMeshCap <= 0) {\n    throw errcode(new Error('invalid TimeInMeshCap; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check P2\n\n\n  if (p.firstMessageDeliveriesWeight < 0) {\n    throw errcode(new Error('invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.firstMessageDeliveriesWeight !== 0 && (p.firstMessageDeliveriesDecay <= 0 || p.firstMessageDeliveriesDecay >= 1)) {\n    throw errcode(new Error('invalid FirstMessageDeliveriesDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.firstMessageDeliveriesWeight !== 0 && p.firstMessageDeliveriesCap <= 0) {\n    throw errcode(new Error('invalid FirstMessageDeliveriesCap; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check P3\n\n\n  if (p.meshMessageDeliveriesWeight > 0) {\n    throw errcode(new Error('invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.meshMessageDeliveriesWeight !== 0 && (p.meshMessageDeliveriesDecay <= 0 || p.meshMessageDeliveriesDecay >= 1)) {\n    throw errcode(new Error('invalid MeshMessageDeliveriesDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesCap <= 0) {\n    throw errcode(new Error('invalid MeshMessageDeliveriesCap; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesThreshold <= 0) {\n    throw errcode(new Error('invalid MeshMessageDeliveriesThreshold; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.meshMessageDeliveriesWindow < 0) {\n    throw errcode(new Error('invalid MeshMessageDeliveriesWindow; must be non-negative'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesActivation < 1000) {\n    throw errcode(new Error('invalid MeshMessageDeliveriesActivation; must be at least 1s'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check P3b\n\n\n  if (p.meshFailurePenaltyWeight > 0) {\n    throw errcode(new Error('invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.meshFailurePenaltyWeight !== 0 && (p.meshFailurePenaltyDecay <= 0 || p.meshFailurePenaltyDecay >= 1)) {\n    throw errcode(new Error('invalid MeshFailurePenaltyDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  } // check P4\n\n\n  if (p.invalidMessageDeliveriesWeight > 0) {\n    throw errcode(new Error('invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n\n  if (p.invalidMessageDeliveriesDecay <= 0 || p.invalidMessageDeliveriesDecay >= 1) {\n    throw errcode(new Error('invalid InvalidMessageDeliveriesDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n  }\n}\n\nexports.validateTopicScoreParams = validateTopicScoreParams;","map":{"version":3,"sources":["C:/Users/user/mew-supplychain/front-end/node_modules/libp2p-gossipsub/src/score/peer-score-params.js"],"names":["Object","defineProperty","exports","value","validateTopicScoreParams","validatePeerScoreParams","createTopicScoreParams","createPeerScoreParams","defaultTopicScoreParams","defaultPeerScoreParams","constants_1","require","errcode","topics","topicScoreCap","appSpecificScore","appSpecificWeight","IPColocationFactorWeight","IPColocationFactorThreshold","IPColocationFactorWhitelist","Set","behaviourPenaltyWeight","behaviourPenaltyDecay","decayInterval","decayToZero","retainScore","topicWeight","timeInMeshWeight","timeInMeshQuantum","timeInMeshCap","firstMessageDeliveriesWeight","firstMessageDeliveriesDecay","firstMessageDeliveriesCap","meshMessageDeliveriesWeight","meshMessageDeliveriesDecay","meshMessageDeliveriesCap","meshMessageDeliveriesThreshold","meshMessageDeliveriesWindow","meshMessageDeliveriesActivation","meshFailurePenaltyWeight","meshFailurePenaltyDecay","invalidMessageDeliveriesWeight","invalidMessageDeliveriesDecay","p","assign","entries","reduce","topic","topicScoreParams","params","e","Error","message","ERR_INVALID_PEER_SCORE_PARAMS","undefined"],"mappings":"AAAA;;AACAA,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEC,EAAAA,KAAK,EAAE;AAAT,CAA7C;AACAD,OAAO,CAACE,wBAAR,GAAmCF,OAAO,CAACG,uBAAR,GAAkCH,OAAO,CAACI,sBAAR,GAAiCJ,OAAO,CAACK,qBAAR,GAAgCL,OAAO,CAACM,uBAAR,GAAkCN,OAAO,CAACO,sBAAR,GAAiC,KAAK,CAA9M;;AACA,MAAMC,WAAW,GAAGC,OAAO,CAAC,aAAD,CAA3B,C,CACA;AACA;;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,UAAD,CAAvB;;AACAT,OAAO,CAACO,sBAAR,GAAiC;AAC7BI,EAAAA,MAAM,EAAE,EADqB;AAE7BC,EAAAA,aAAa,EAAE,EAFc;AAG7BC,EAAAA,gBAAgB,EAAE,MAAM,CAHK;AAI7BC,EAAAA,iBAAiB,EAAE,EAJU;AAK7BC,EAAAA,wBAAwB,EAAE,CAAC,CALE;AAM7BC,EAAAA,2BAA2B,EAAE,EANA;AAO7BC,EAAAA,2BAA2B,EAAE,IAAIC,GAAJ,EAPA;AAQ7BC,EAAAA,sBAAsB,EAAE,CAAC,EARI;AAS7BC,EAAAA,qBAAqB,EAAE,GATM;AAU7BC,EAAAA,aAAa,EAAE,IAVc;AAW7BC,EAAAA,WAAW,EAAE,GAXgB;AAY7BC,EAAAA,WAAW,EAAE,OAAO;AAZS,CAAjC;AAcAvB,OAAO,CAACM,uBAAR,GAAkC;AAC9BkB,EAAAA,WAAW,EAAE,GADiB;AAE9BC,EAAAA,gBAAgB,EAAE,CAFY;AAG9BC,EAAAA,iBAAiB,EAAE,CAHW;AAI9BC,EAAAA,aAAa,EAAE,IAJe;AAK9BC,EAAAA,4BAA4B,EAAE,CALA;AAM9BC,EAAAA,2BAA2B,EAAE,GANC;AAO9BC,EAAAA,yBAAyB,EAAE,IAPG;AAQ9BC,EAAAA,2BAA2B,EAAE,CAAC,CARA;AAS9BC,EAAAA,0BAA0B,EAAE,GATE;AAU9BC,EAAAA,wBAAwB,EAAE,GAVI;AAW9BC,EAAAA,8BAA8B,EAAE,EAXF;AAY9BC,EAAAA,2BAA2B,EAAE,EAZC;AAa9BC,EAAAA,+BAA+B,EAAE,IAbH;AAc9BC,EAAAA,wBAAwB,EAAE,CAAC,CAdG;AAe9BC,EAAAA,uBAAuB,EAAE,GAfK;AAgB9BC,EAAAA,8BAA8B,EAAE,CAAC,CAhBH;AAiB9BC,EAAAA,6BAA6B,EAAE;AAjBD,CAAlC;;AAmBA,SAASnC,qBAAT,CAA+BoC,CAAC,GAAG,EAAnC,EAAuC;AACnC,SAAO3C,MAAM,CAAC4C,MAAP,CAAc5C,MAAM,CAAC4C,MAAP,CAAc5C,MAAM,CAAC4C,MAAP,CAAc,EAAd,EAAkB1C,OAAO,CAACO,sBAA1B,CAAd,EAAiEkC,CAAjE,CAAd,EAAmF;AAAE9B,IAAAA,MAAM,EAAE8B,CAAC,CAAC9B,MAAF,GAC1Fb,MAAM,CAAC6C,OAAP,CAAeF,CAAC,CAAC9B,MAAjB,EACGiC,MADH,CACU,CAACjC,MAAD,EAAS,CAACkC,KAAD,EAAQC,gBAAR,CAAT,KAAuC;AAC/CnC,MAAAA,MAAM,CAACkC,KAAD,CAAN,GAAgBzC,sBAAsB,CAAC0C,gBAAD,CAAtC;AACA,aAAOnC,MAAP;AACH,KAJC,EAIC,EAJD,CAD0F,GAM1F;AANgF,GAAnF,CAAP;AAOH;;AACDX,OAAO,CAACK,qBAAR,GAAgCA,qBAAhC;;AACA,SAASD,sBAAT,CAAgCqC,CAAC,GAAG,EAApC,EAAwC;AACpC,SAAO3C,MAAM,CAAC4C,MAAP,CAAc5C,MAAM,CAAC4C,MAAP,CAAc,EAAd,EAAkB1C,OAAO,CAACM,uBAA1B,CAAd,EAAkEmC,CAAlE,CAAP;AACH;;AACDzC,OAAO,CAACI,sBAAR,GAAiCA,sBAAjC,C,CACA;;AACA,SAASD,uBAAT,CAAiCsC,CAAjC,EAAoC;AAChC,OAAK,MAAM,CAACI,KAAD,EAAQE,MAAR,CAAX,IAA8BjD,MAAM,CAAC6C,OAAP,CAAeF,CAAC,CAAC9B,MAAjB,CAA9B,EAAwD;AACpD,QAAI;AACAT,MAAAA,wBAAwB,CAAC6C,MAAD,CAAxB;AACH,KAFD,CAGA,OAAOC,CAAP,EAAU;AACN,YAAMtC,OAAO,CAAC,IAAIuC,KAAJ,CAAW,sCAAqCJ,KAAM,KAAIG,CAAC,CAACE,OAAQ,EAApE,CAAD,EAAyE1C,WAAW,CAAC2C,6BAArF,CAAb;AACH;AACJ,GAR+B,CAShC;;;AACA,MAAIV,CAAC,CAAC7B,aAAF,GAAkB,CAAtB,EAAyB;AACrB,UAAMF,OAAO,CAAC,IAAIuC,KAAJ,CAAU,6DAAV,CAAD,EAA2EzC,WAAW,CAAC2C,6BAAvF,CAAb;AACH,GAZ+B,CAahC;;;AACA,MAAIV,CAAC,CAAC5B,gBAAF,KAAuB,IAAvB,IAA+B4B,CAAC,CAAC5B,gBAAF,KAAuBuC,SAA1D,EAAqE;AACjE,UAAM1C,OAAO,CAAC,IAAIuC,KAAJ,CAAU,6CAAV,CAAD,EAA2DzC,WAAW,CAAC2C,6BAAvE,CAAb;AACH,GAhB+B,CAiBhC;;;AACA,MAAIV,CAAC,CAAC1B,wBAAF,GAA6B,CAAjC,EAAoC;AAChC,UAAML,OAAO,CAAC,IAAIuC,KAAJ,CAAU,sEAAV,CAAD,EAAoFzC,WAAW,CAAC2C,6BAAhG,CAAb;AACH;;AACD,MAAIV,CAAC,CAAC1B,wBAAF,KAA+B,CAA/B,IAAoC0B,CAAC,CAACzB,2BAAF,GAAgC,CAAxE,EAA2E;AACvE,UAAMN,OAAO,CAAC,IAAIuC,KAAJ,CAAU,yDAAV,CAAD,EAAuEzC,WAAW,CAAC2C,6BAAnF,CAAb;AACH,GAvB+B,CAwBhC;;;AACA,MAAIV,CAAC,CAACtB,sBAAF,GAA2B,CAA/B,EAAkC;AAC9B,UAAMT,OAAO,CAAC,IAAIuC,KAAJ,CAAU,oEAAV,CAAD,EAAkFzC,WAAW,CAAC2C,6BAA9F,CAAb;AACH;;AACD,MAAIV,CAAC,CAACtB,sBAAF,KAA6B,CAA7B,KAAmCsB,CAAC,CAACrB,qBAAF,IAA2B,CAA3B,IAAgCqB,CAAC,CAACrB,qBAAF,IAA2B,CAA9F,CAAJ,EAAsG;AAClG,UAAMV,OAAO,CAAC,IAAIuC,KAAJ,CAAU,wDAAV,CAAD,EAAsEzC,WAAW,CAAC2C,6BAAlF,CAAb;AACH,GA9B+B,CA+BhC;;;AACA,MAAIV,CAAC,CAACpB,aAAF,GAAkB,IAAtB,EAA4B;AACxB,UAAMX,OAAO,CAAC,IAAIuC,KAAJ,CAAU,4CAAV,CAAD,EAA0DzC,WAAW,CAAC2C,6BAAtE,CAAb;AACH;;AACD,MAAIV,CAAC,CAACnB,WAAF,IAAiB,CAAjB,IAAsBmB,CAAC,CAACnB,WAAF,IAAiB,CAA3C,EAA8C;AAC1C,UAAMZ,OAAO,CAAC,IAAIuC,KAAJ,CAAU,8CAAV,CAAD,EAA4DzC,WAAW,CAAC2C,6BAAxE,CAAb;AACH,GArC+B,CAsChC;;AACH;;AACDnD,OAAO,CAACG,uBAAR,GAAkCA,uBAAlC;;AACA,SAASD,wBAAT,CAAkCuC,CAAlC,EAAqC;AACjC;AACA,MAAIA,CAAC,CAACjB,WAAF,GAAgB,CAApB,EAAuB;AACnB,UAAMd,OAAO,CAAC,IAAIuC,KAAJ,CAAU,oCAAV,CAAD,EAAkDzC,WAAW,CAAC2C,6BAA9D,CAAb;AACH,GAJgC,CAKjC;;;AACA,MAAIV,CAAC,CAACf,iBAAF,KAAwB,CAA5B,EAA+B;AAC3B,UAAMhB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,6CAAV,CAAD,EAA2DzC,WAAW,CAAC2C,6BAAvE,CAAb;AACH;;AACD,MAAIV,CAAC,CAAChB,gBAAF,GAAqB,CAAzB,EAA4B;AACxB,UAAMf,OAAO,CAAC,IAAIuC,KAAJ,CAAU,8DAAV,CAAD,EAA4EzC,WAAW,CAAC2C,6BAAxF,CAAb;AACH;;AACD,MAAIV,CAAC,CAAChB,gBAAF,KAAuB,CAAvB,IAA4BgB,CAAC,CAACf,iBAAF,IAAuB,CAAvD,EAA0D;AACtD,UAAMhB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,6CAAV,CAAD,EAA2DzC,WAAW,CAAC2C,6BAAvE,CAAb;AACH;;AACD,MAAIV,CAAC,CAAChB,gBAAF,KAAuB,CAAvB,IAA4BgB,CAAC,CAACd,aAAF,IAAmB,CAAnD,EAAsD;AAClD,UAAMjB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,yCAAV,CAAD,EAAuDzC,WAAW,CAAC2C,6BAAnE,CAAb;AACH,GAjBgC,CAkBjC;;;AACA,MAAIV,CAAC,CAACb,4BAAF,GAAiC,CAArC,EAAwC;AACpC,UAAMlB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,2EAAV,CAAD,EAAyFzC,WAAW,CAAC2C,6BAArG,CAAb;AACH;;AACD,MAAIV,CAAC,CAACb,4BAAF,KAAmC,CAAnC,KAAyCa,CAAC,CAACZ,2BAAF,IAAiC,CAAjC,IAAsCY,CAAC,CAACZ,2BAAF,IAAiC,CAAhH,CAAJ,EAAwH;AACpH,UAAMnB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,8DAAV,CAAD,EAA4EzC,WAAW,CAAC2C,6BAAxF,CAAb;AACH;;AACD,MAAIV,CAAC,CAACb,4BAAF,KAAmC,CAAnC,IAAwCa,CAAC,CAACX,yBAAF,IAA+B,CAA3E,EAA8E;AAC1E,UAAMpB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,qDAAV,CAAD,EAAmEzC,WAAW,CAAC2C,6BAA/E,CAAb;AACH,GA3BgC,CA4BjC;;;AACA,MAAIV,CAAC,CAACV,2BAAF,GAAgC,CAApC,EAAuC;AACnC,UAAMrB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,yEAAV,CAAD,EAAuFzC,WAAW,CAAC2C,6BAAnG,CAAb;AACH;;AACD,MAAIV,CAAC,CAACV,2BAAF,KAAkC,CAAlC,KAAwCU,CAAC,CAACT,0BAAF,IAAgC,CAAhC,IAAqCS,CAAC,CAACT,0BAAF,IAAgC,CAA7G,CAAJ,EAAqH;AACjH,UAAMtB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,6DAAV,CAAD,EAA2EzC,WAAW,CAAC2C,6BAAvF,CAAb;AACH;;AACD,MAAIV,CAAC,CAACV,2BAAF,KAAkC,CAAlC,IAAuCU,CAAC,CAACR,wBAAF,IAA8B,CAAzE,EAA4E;AACxE,UAAMvB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,oDAAV,CAAD,EAAkEzC,WAAW,CAAC2C,6BAA9E,CAAb;AACH;;AACD,MAAIV,CAAC,CAACV,2BAAF,KAAkC,CAAlC,IAAuCU,CAAC,CAACP,8BAAF,IAAoC,CAA/E,EAAkF;AAC9E,UAAMxB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,0DAAV,CAAD,EAAwEzC,WAAW,CAAC2C,6BAApF,CAAb;AACH;;AACD,MAAIV,CAAC,CAACN,2BAAF,GAAgC,CAApC,EAAuC;AACnC,UAAMzB,OAAO,CAAC,IAAIuC,KAAJ,CAAU,2DAAV,CAAD,EAAyEzC,WAAW,CAAC2C,6BAArF,CAAb;AACH;;AACD,MAAIV,CAAC,CAACV,2BAAF,KAAkC,CAAlC,IAAuCU,CAAC,CAACL,+BAAF,GAAoC,IAA/E,EAAqF;AACjF,UAAM1B,OAAO,CAAC,IAAIuC,KAAJ,CAAU,8DAAV,CAAD,EAA4EzC,WAAW,CAAC2C,6BAAxF,CAAb;AACH,GA9CgC,CA+CjC;;;AACA,MAAIV,CAAC,CAACJ,wBAAF,GAA6B,CAAjC,EAAoC;AAChC,UAAM3B,OAAO,CAAC,IAAIuC,KAAJ,CAAU,sEAAV,CAAD,EAAoFzC,WAAW,CAAC2C,6BAAhG,CAAb;AACH;;AACD,MAAIV,CAAC,CAACJ,wBAAF,KAA+B,CAA/B,KAAqCI,CAAC,CAACH,uBAAF,IAA6B,CAA7B,IAAkCG,CAAC,CAACH,uBAAF,IAA6B,CAApG,CAAJ,EAA4G;AACxG,UAAM5B,OAAO,CAAC,IAAIuC,KAAJ,CAAU,0DAAV,CAAD,EAAwEzC,WAAW,CAAC2C,6BAApF,CAAb;AACH,GArDgC,CAsDjC;;;AACA,MAAIV,CAAC,CAACF,8BAAF,GAAmC,CAAvC,EAA0C;AACtC,UAAM7B,OAAO,CAAC,IAAIuC,KAAJ,CAAU,4EAAV,CAAD,EAA0FzC,WAAW,CAAC2C,6BAAtG,CAAb;AACH;;AACD,MAAIV,CAAC,CAACD,6BAAF,IAAmC,CAAnC,IAAwCC,CAAC,CAACD,6BAAF,IAAmC,CAA/E,EAAkF;AAC9E,UAAM9B,OAAO,CAAC,IAAIuC,KAAJ,CAAU,gEAAV,CAAD,EAA8EzC,WAAW,CAAC2C,6BAA1F,CAAb;AACH;AACJ;;AACDnD,OAAO,CAACE,wBAAR,GAAmCA,wBAAnC","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.validateTopicScoreParams = exports.validatePeerScoreParams = exports.createTopicScoreParams = exports.createPeerScoreParams = exports.defaultTopicScoreParams = exports.defaultPeerScoreParams = void 0;\nconst constants_1 = require(\"./constants\");\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nconst errcode = require(\"err-code\");\nexports.defaultPeerScoreParams = {\n    topics: {},\n    topicScoreCap: 10,\n    appSpecificScore: () => 0,\n    appSpecificWeight: 10,\n    IPColocationFactorWeight: -5,\n    IPColocationFactorThreshold: 10,\n    IPColocationFactorWhitelist: new Set(),\n    behaviourPenaltyWeight: -10,\n    behaviourPenaltyDecay: 0.2,\n    decayInterval: 1000,\n    decayToZero: 0.1,\n    retainScore: 3600 * 1000\n};\nexports.defaultTopicScoreParams = {\n    topicWeight: 0.5,\n    timeInMeshWeight: 1,\n    timeInMeshQuantum: 1,\n    timeInMeshCap: 3600,\n    firstMessageDeliveriesWeight: 1,\n    firstMessageDeliveriesDecay: 0.5,\n    firstMessageDeliveriesCap: 2000,\n    meshMessageDeliveriesWeight: -1,\n    meshMessageDeliveriesDecay: 0.5,\n    meshMessageDeliveriesCap: 100,\n    meshMessageDeliveriesThreshold: 20,\n    meshMessageDeliveriesWindow: 10,\n    meshMessageDeliveriesActivation: 5000,\n    meshFailurePenaltyWeight: -1,\n    meshFailurePenaltyDecay: 0.5,\n    invalidMessageDeliveriesWeight: -1,\n    invalidMessageDeliveriesDecay: 0.3\n};\nfunction createPeerScoreParams(p = {}) {\n    return Object.assign(Object.assign(Object.assign({}, exports.defaultPeerScoreParams), p), { topics: p.topics\n            ? Object.entries(p.topics)\n                .reduce((topics, [topic, topicScoreParams]) => {\n                topics[topic] = createTopicScoreParams(topicScoreParams);\n                return topics;\n            }, {})\n            : {} });\n}\nexports.createPeerScoreParams = createPeerScoreParams;\nfunction createTopicScoreParams(p = {}) {\n    return Object.assign(Object.assign({}, exports.defaultTopicScoreParams), p);\n}\nexports.createTopicScoreParams = createTopicScoreParams;\n// peer score parameter validation\nfunction validatePeerScoreParams(p) {\n    for (const [topic, params] of Object.entries(p.topics)) {\n        try {\n            validateTopicScoreParams(params);\n        }\n        catch (e) {\n            throw errcode(new Error(`invalid score parameters for topic ${topic}: ${e.message}`), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n        }\n    }\n    // check that the topic score is 0 or something positive\n    if (p.topicScoreCap < 0) {\n        throw errcode(new Error('invalid topic score cap; must be positive (or 0 for no cap)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check that we have an app specific score; the weight can be anything (but expected positive)\n    if (p.appSpecificScore === null || p.appSpecificScore === undefined) {\n        throw errcode(new Error('missing application specific score function'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check the IP colocation factor\n    if (p.IPColocationFactorWeight > 0) {\n        throw errcode(new Error('invalid IPColocationFactorWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.IPColocationFactorWeight !== 0 && p.IPColocationFactorThreshold < 1) {\n        throw errcode(new Error('invalid IPColocationFactorThreshold; must be at least 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check the behaviour penalty\n    if (p.behaviourPenaltyWeight > 0) {\n        throw errcode(new Error('invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.behaviourPenaltyWeight !== 0 && (p.behaviourPenaltyDecay <= 0 || p.behaviourPenaltyDecay >= 1)) {\n        throw errcode(new Error('invalid BehaviourPenaltyDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check the decay parameters\n    if (p.decayInterval < 1000) {\n        throw errcode(new Error('invalid DecayInterval; must be at least 1s'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.decayToZero <= 0 || p.decayToZero >= 1) {\n        throw errcode(new Error('invalid DecayToZero; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // no need to check the score retention; a value of 0 means that we don't retain scores\n}\nexports.validatePeerScoreParams = validatePeerScoreParams;\nfunction validateTopicScoreParams(p) {\n    // make sure we have a sane topic weight\n    if (p.topicWeight < 0) {\n        throw errcode(new Error('invalid topic weight; must be >= 0'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check P1\n    if (p.timeInMeshQuantum === 0) {\n        throw errcode(new Error('invalid TimeInMeshQuantum; must be non zero'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.timeInMeshWeight < 0) {\n        throw errcode(new Error('invalid TimeInMeshWeight; must be positive (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.timeInMeshWeight !== 0 && p.timeInMeshQuantum <= 0) {\n        throw errcode(new Error('invalid TimeInMeshQuantum; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.timeInMeshWeight !== 0 && p.timeInMeshCap <= 0) {\n        throw errcode(new Error('invalid TimeInMeshCap; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check P2\n    if (p.firstMessageDeliveriesWeight < 0) {\n        throw errcode(new Error('invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.firstMessageDeliveriesWeight !== 0 && (p.firstMessageDeliveriesDecay <= 0 || p.firstMessageDeliveriesDecay >= 1)) {\n        throw errcode(new Error('invalid FirstMessageDeliveriesDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.firstMessageDeliveriesWeight !== 0 && p.firstMessageDeliveriesCap <= 0) {\n        throw errcode(new Error('invalid FirstMessageDeliveriesCap; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check P3\n    if (p.meshMessageDeliveriesWeight > 0) {\n        throw errcode(new Error('invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.meshMessageDeliveriesWeight !== 0 && (p.meshMessageDeliveriesDecay <= 0 || p.meshMessageDeliveriesDecay >= 1)) {\n        throw errcode(new Error('invalid MeshMessageDeliveriesDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesCap <= 0) {\n        throw errcode(new Error('invalid MeshMessageDeliveriesCap; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesThreshold <= 0) {\n        throw errcode(new Error('invalid MeshMessageDeliveriesThreshold; must be positive'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.meshMessageDeliveriesWindow < 0) {\n        throw errcode(new Error('invalid MeshMessageDeliveriesWindow; must be non-negative'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.meshMessageDeliveriesWeight !== 0 && p.meshMessageDeliveriesActivation < 1000) {\n        throw errcode(new Error('invalid MeshMessageDeliveriesActivation; must be at least 1s'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check P3b\n    if (p.meshFailurePenaltyWeight > 0) {\n        throw errcode(new Error('invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.meshFailurePenaltyWeight !== 0 && (p.meshFailurePenaltyDecay <= 0 || p.meshFailurePenaltyDecay >= 1)) {\n        throw errcode(new Error('invalid MeshFailurePenaltyDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    // check P4\n    if (p.invalidMessageDeliveriesWeight > 0) {\n        throw errcode(new Error('invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n    if (p.invalidMessageDeliveriesDecay <= 0 || p.invalidMessageDeliveriesDecay >= 1) {\n        throw errcode(new Error('invalid InvalidMessageDeliveriesDecay; must be between 0 and 1'), constants_1.ERR_INVALID_PEER_SCORE_PARAMS);\n    }\n}\nexports.validateTopicScoreParams = validateTopicScoreParams;\n"]},"metadata":{},"sourceType":"script"}